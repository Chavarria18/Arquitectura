kind: pipeline 

steps:

steps:
  - name: UnitTest
    image: maven:3-jdk-11
    commands:    
      - mvn test
  - name: Sonar
    image: maven:3-jdk-11
    commands:
      - mvn clean verify sonar:sonar -Dsonar.login=admin -Dsonar.password=mora456 -Dsonar.host.url=http://52.188.188.66:9000

- name: notify-unit-test 
  image: drillster/drone-email
  settings:
    from: chavarria181386@unis.edu.gt    
    host: smtp.sendgrid.net
    port: 465
    username:
       from_secret: emu1
    password: 
      from_secret: emu2    
    
    recipients:
        - gchavarriamunoz@gmail.com
    body: Los unit test fallaron 
    attachment: build-result.xml
  when:
    status:
    - success
    - failure
 





  - name: QualityGate
    image: maven:3-jdk-11
    commands:
      - mvn clean verify sonar:sonar sonar-quality-gate:check -Dsonar.login=admin -Dsonar.password=mora456 -Dsonar.host.url=http://52.188.188.66:9000



- name: Build-dev
  image: maven:3-jdk-11
  commands:  
    - mvn -f ventas/pom.xml -Dspring.profiles.active=dev clean  install
  when:
    branch:
      - DEV
    event:
      include:
      - push
      - pull_request

  



- name: Build-uat
  image: maven:3-jdk-11
  commands:  
    - mvn -f ventas/pom.xml -Dspring.profiles.active=uat clean install
  when:
    branch:
      - UAT
    event:
      include:
      - push
      - pull_request


- name: Build-prod
  image: maven:3-jdk-11
  commands:  
    - mvn -f ventas/pom.xml -Dspring.profiles.active=prod clean install
  when:
    branch:
      - 1PROD
    event:
      include:
      - push
      - pull_request

      

- name: Build-main
  image: maven:3-jdk-11
  commands:  
    - mvn -f ventas/pom.xml -Dspring.profiles.active=prod clean install
    
  when:
    branch:
      - main
    event:
      include:
      - push
      - pull_request


     
      

- name: Servers-dev
  image: alpine
  commands:
    - ls
    - cd /drone/src/ventas/target/
    - ls
    - apk add curl
    - stat ventas-0.0.1-SNAPSHOT.war
    - mv  ventas-0.0.1-SNAPSHOT.war main.war
    - curl -v -u admin:admin -T main.war 'http://wzcvu06han7aiqu3qovyj5.webrelay.io/manager/text/deploy?path=/main-dev&update=true'
  when:
    branch:
      - DEV
    event:
      include:
      - push
      - pull_request

    


- name: Servers-uat
  image: alpine
  commands:
    - ls
    - cd /drone/src/ventas/target/
    - ls
    - apk add curl
    - stat ventas-0.0.1-SNAPSHOT.war
    - mv  ventas-0.0.1-SNAPSHOT.war main.war  
    - curl -v -u admin:admin -T main.war 'http://wzcvu06han7aiqu3qovyj5.webrelay.io/manager/text/deploy?path=/main-uat&update=true'
  when:
    branch:
      - UAT
    event:
      include:
      - push
      - pull_request


- name: Servers-prod
  image: alpine
  commands:
    - ls
    - cd /drone/src/ventas/target/
    - ls
    - apk add curl
    - stat ventas-0.0.1-SNAPSHOT.war
    - mv  ventas-0.0.1-SNAPSHOT.war main.war
    - curl -v -u admin:admin -T main.war 'http://wzcvu06han7aiqu3qovyj5.webrelay.io/manager/text/deploy?path=/main-prod&update=true'
  when:
    branch:
      - 1PROD
    event:
      include:
      - push
      - pull_request

      
- name: Servers-main
  image: alpine
  commands:
    - ls
    - cd /drone/src/ventas/target/
    - ls
    - apk add curl
    - stat ventas-0.0.1-SNAPSHOT.war
    - mv  ventas-0.0.1-SNAPSHOT.war main.war
    - curl -v -u admin:admin -T main.war 'http://wzcvu06han7aiqu3qovyj5.webrelay.io/manager/text/deploy?path=/main-prodmain&update=true'
  when:
    branch:
      - main
    
    event:
      include:
      - push
      - pull_request

 



    



- name: notify
  image: drillster/drone-email
  settings:
    from: chavarria181386@unis.edu.gt    
    host: smtp.sendgrid.net
    port: 465
    username:
       from_secret: emu1
    password: 
      from_secret: emu2    
    
    recipients:
        - gchavarriamunoz@gmail.com

  when:
    status:
    - success
    - failure
 

    
    
