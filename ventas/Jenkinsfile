node {

stage 'Checkout'
  checkout scm


 stage('unit-test') {
   try{
     
     
      def mvnHome =  tool name: 'M3', type: 'maven'                 
      echo "REALIZANDO LOS UNIT TESTS-2"
      echo "ahora"
      sh "ls"
      //sh "'${mvnHome}/bin/mvn test'"



      withMaven(maven: 'M3') {
            sh "mvn -f ventas/pom.xml test"
        }

   }catch(err){
     //emailext attachLog: false,body: 'Hubo un error en los unit test', subject: 'Jenkins-pipeline-status', to: 'gchavarriamunoz@gmail.com'
     //emailext attachLog: false,body: 'Hubo un error en los unit test', subject: 'Jenkins-pipeline-status', to: 'jflores@unis.edu.gt'

   }

    
        
    }
                     
                


  stage('SonarQube Analysis') {
    try{
        def mvnHome =  tool name: 'M3', type: 'maven'
        withSonarQubeEnv('sonarq') { 
          sh "${mvnHome}/bin/mvn sonar:sonar -Dsonar.login=admin -Dsonar.password=tzec99"
        }

    }catch(err){
     // emailext attachLog: false,body: 'Hubo un error en sonarqube', subject: 'Jenkins-pipeline-status', to: 'gchavarriamunoz@gmail.com'

    }}
  
    

    stage('Build') {
      try{ 
      def mvnHome =  tool name: 'M3', type: 'maven'       
      echo "REALIZANDO EL BUILD"
      sh "${mvnHome}/bin/mvn build"
      }catch(err){
       // emailext attachLog: false,body: 'Hubo un error en el build', subject: 'Jenkins-pipeline-status', to: 'gchavarriamunoz@gmail.com'
      }
        
        
    } 
    

       stage('Server') {
      try{ 
        sh "docker cp ~/target/ventas-0.0.1-SNAPSHOT.jar mytomcat:/opt/apache-tomcat-8.5.50/webapps"
        sh "docker exec -i mytomcat bash ./opt/apache-tomcat-8.5.50/bin/shutdown.sh"
        sh"docker exec -i mytomcat bash ./opt/apache-tomcat-8.5.50/bin/startup.sh"

   

     
      }catch(err){
       // emailext attachLog: false,body: 'Hubo un error en el build', subject: 'Jenkins-pipeline-status', to: 'gchavarriamunoz@gmail.com'
      }
        
        
    } 



}
